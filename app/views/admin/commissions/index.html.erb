<% provide(:title, "Comisiones") %>
<%= render partial: "/shared/admin/header_band", locals: {title: "Comisiones", labels: ['Comisiones']} %>

<!--Content whit animation-->
<div class="wrapper wrapper-content animated fadeInRight">
  <div class="row">

    <div class="ibox">
        <div class="ibox-content text-center">
            <h3 class="m-b-xxs">Listado de comisiones</h3>
            <small>En este apartado se muestra la lista de las comisiones registradas de las órdenes entregadas,
              aquí puedes ver los detalles de la comisión y cargar su respectivo comprobante de pago.</small>
        </div>
    </div>

    <div class="ibox">
    	<div class="ibox-content">

    			<div class="row m-b-sm m-t-sm">
            <div class="col-md-10">
              <input type="text" class="form-control input-sm m-b-xs" id="filter" maxlength="25" placeholder="Buscar en tabla">
            </div>
    				<div class="col-md-2">
    					<%= link_to(admin_commissions_path, :class => "btn btn-white btn-sm full-width") do %>
    						<i class="fa fa-refresh"></i> Actualizar
    					<% end %>
    				</div>
    			</div>

          <table class="footable table table-stripped  toggle-arrow-tiny" data-filter=#filter>
              <thead>
                <tr>
                    <th data-hide="phone">Clave</th>
                    <th>Total a pagar</th>
                    <th data-hide="phone">Distribuidor</th>
                    <th data-hide="phone,tablet">Status</th>
                    <th>Comprobante de pago</th>
                    <th>Fecha de pago</th>
                    <th>Factura</th>
                    <th data-hide="phone">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <% @commissions.each do |c| %>
                  <tr>
                    <td><%= c.alph_key %></td>
                    <td>$ <%= c.total %></td>
                    <% distributor = c.Distributor %>
                    <td><%= link_to distributor.username,
                                    admin_distributor_path(distributor.alph_key) %></td>
                    <td>
                      <% case t(c.state)
                        when "Por pagar"%>
                        <label class="label label-danger"><%=t(c.state)%></label>
                      <%when "Pago depositado"%>
                        <label class="label label-primary"><%=t(c.state)%></label>
                      <%when "Pagado y se recibió factura"%>
                        <label class="label label-success"><%=t(c.state)%></label>
                      <%else%>
                        <label class="label label-information"><%=t(c.state)%></label>
                      <%end%>
                    </td>
                    <td class="text-center">
                      <% if !c.payment_img.blank? %>
                        <%= link_to image_tag(c.payment_img.url(:mini), :class => "img-rounded", :style =>"width:60px;"),
                            image_path(c.payment_img.url), :data => {:toggle => "lightbox", :title => "Pago de la comisión: " + c.alph_key } %>
                      <% elsif !c.payment_pdf.blank? %>
                        <%= link_to "<i class='fa fa-file-pdf-o fa-5x'></i>".html_safe,
                            c.payment_pdf.url, target: "_blank" %>
                      <% end %>
                    </td>
                    <td><%= l(Time.parse(c.payment_day), format: :long) if !c.payment_day.blank? %></td>
                    <td class="text-center">
                      <% if !c.invoice.blank? %>
                        <%= link_to "<i class='fa fa-file-archive-o fa-5x'></i>".html_safe,
                            admin_download_commission_invoice_path(c.alph_key), target: "_blank" %>
                        <% if c.invoice_downloaded %>
                          <i class="fa fa-download fa-3x" style="color: #8BC34A"></i>
                        <% end %>
                      <% end %>
                    </td>
                    <td>
                      <%= link_to "<i class='fa fa-eye'></i> Detalles".html_safe,
                                  admin_commission_details_path(c.alph_key),
                                  :class => "btn btn-white btn-sm m-b-xs" %>

                        <%= form_for(Commission.new, url: admin_upload_commission_payment_path(c.alph_key)) do |f| %>
                          <a onclick="$('#payment_field_<%=c.alph_key%>').click();" class="btn btn-white btn-sm m-b-xs">
                            <i class="fa fa-upload"></i> Subir comprobante de pago
                          </a>

                          <%= f.file_field :payment, id: "payment_field_#{c.alph_key}",
                              :style =>"display: none;", :multiple => false,
                              :onchange => "$('#payment_commit_#{c.alph_key}').click();" %>
                          <%= f.submit "commit", id: "payment_commit_#{c.alph_key}", style: "display: none;",
                              data: {confirm: "Estas seguro(a) de ser el archivo correcto?"} %>
                        <% end #form end# %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="8">
                    <div class="pull-right">
                      <%= will_paginate @commissions, renderer: BootstrapPagination::Rails %>
                    </div>
                  </td>
                </tr>
              </tfoot>
          </table>

          <script>
              $(document).ready(function() {

              });
          </script>

    	</div>
    </div>

 </div>
</div>

<script type="text/javascript">
$(document).ready(function(){
  // init footable
  $('.footable').footable();

  // init ekko-lightbox
  $(document).on('click', '[data-toggle="lightbox"]', function(event) {
    event.preventDefault();
    $(this).ekkoLightbox();
  });
});
</script>

<%= stylesheet_link_tag 'ekko-lightbox.min', media: 'all' %>
<%= javascript_include_tag 'ekko-lightbox.min' %>

<% if @updated %>

  // save values into variables
  var product = "<%=params[:product]%>";
  var product_prev_cost = parseFloat($("#"+product+"-cost").text().replace(",",""));
  var last_shipping_cost = parseFloat($("#order-shipping-cost").text().replace(",",""));

  var wholesale = parseFloat($("#wholesale").text());

  // obtain the cost per unit of a product
  var cost_per_unit = product_prev_cost/<%=@prev_quantity%>;
  // obtain the new cost for that specific product when buying <%=params[:new_quantity]%> unit(s)
  var product_new_cost = cost_per_unit*<%=params[:new_quantity]%>;

  $("#"+product+"-cost").text(money_format(product_new_cost.toString()));

  var difference = product_prev_cost - product_new_cost;
  var current_grand_total = parseFloat($("#order-grand-total").text().replace(",",""));

  // obtain the current_sub_total
  var current_sub_total = current_grand_total;
  if($("#shipping_cost_is_present").text().trim() == "YES"){
    current_sub_total = current_grand_total - last_shipping_cost;
  } // if $("#shipping_cost_is_present").text() == "YES" end

  // calculate the new sub total, shipping_cost and new grand total
  var new_sub_total = current_sub_total-difference;
  var new_shipping_cost = 0.00;
  var new_grand_total = 0;
  var guides = new Object();

  if(new_sub_total < wholesale){
    $("#shipping_cost_is_present").text("YES");
    if(typeof parcel_prices !== 'undefined' && typeof parcel_weight_limitations !== 'undefined'){
      guides = getGuides(<%= session[:e_cart]["total_weight"] %>, parcel_weight_limitations, parcel_prices);
      new_shipping_cost = calculateDeliveryCost(guides);
    }
  }else{
    $("#shipping_cost_is_present").text("NO");
  }
  $("#delivery_cost").val(new_shipping_cost);
  $("#guides").val(guidesToString(guides));
  console.log(`cart weight: <%= session[:e_cart]["total_weight"]/1000.00 %>Kgs`);
  console.log(`guides: ${$("#guides").val()}`);

  new_grand_total = new_shipping_cost + new_sub_total;

  // update the view
  $("#order-sub-total").text(money_format(new_sub_total.toString()));
  $("#order-shipping-cost").text(money_format(new_shipping_cost.toString()));
  $("#order-grand-total").text(money_format(new_grand_total.toString()));

  <% if @reached_current_existence %>
    var existence = <%= params[:current_existence] %>;
    $("#"+product+"-quantity-input").val(existence);
    <% message = "Solo contamos con #{params[:current_existence]} unidad(es) de este producto." %>
    $("#dismissible_alerts").append("<%= j render partial: '/shared/dismissible_alert', locals: {message_type: :success, message: message} %>");
  <% end %>

<% elsif params[:new_quantity].to_i <= 0 %>
  <% message = "Houston tenemos un problema!, no podemos enviar " + params[:new_quantity] + " producto(s)" %>
  $("#dismissible_alerts").append("<%= j render partial: '/shared/dismissible_alert', locals: {message_type: :success, message: message} %>");

  $("#<%=params[:product]%>-quantity-input").val(<%=session[:e_cart][params[:product]]%>);
<% end %>
